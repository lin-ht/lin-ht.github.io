---
layout: post
title:  Conda Environment configuration for Apple Silicon M1 Mac
date:   2023-05-22 17:30:00
description: Arm64 and x86 Python environments management
tags: notes
categories: note-posts
---
#### Python version management tool -- conda

##### 1. Installation
<a href="https://github.com/conda-forge/miniforge">Miniforge</a> a minimal installer for Conda specific to conda-forge.

Keep package imcompatibility in mind:
some package developers haven't support ARM64 yet.

Short term workaround: create conda environments with x86 architecture on an Apple Silicon Mac.

##### 2. Check enviroment list (may skip)
{% highlight terminal %}
conda env list
{% endhighlight %}

##### 3. Create an enviroment and activate it
Instead of directly creating an enviroment like the following:
{% highlight terminal %}
conda create -n myenv python=3.9
conda activate myenv
{% endhighlight %}

Put those commands into shell function first (add this to ~/.zshrc or ~/.bashrc if you're using Bash):
{% highlight terminal %}
create_x86_conda_environment () {
  # create a conda environment using x86 architecture
  # first argument is environment name, all subsequent arguments will be passed to `conda create`
  # example usage: create_x86_conda_environment myenv_x86 python=3.9
  CONDA_SUBDIR=osx-64 conda create -n $@
  conda activate $1
  conda config --env --set subdir osx-64
}

create_arm_conda_environment () {
  # example usage: create_arm_conda_environment myenv_arm python=3.9
  CONDA_SUBDIR=osx-arm64 conda create -n $@
  conda activate $1
  conda config --env --set subdir osx-arm64
}
{% endhighlight %}

Then create the desired enviroment as:
{% highlight terminal %}
create_x86_conda_environment myenv_x86 python=3.9
{% endhighlight %}

<blockquote>
One of the features of <a href="https://github.com/conda-forge/miniforge">Miniforge3</a> is the ability to define processor specific sub-directories for specific Python environments. For example, by setting CONDA_SUBDIR=osx-64, conda will be instructed to install packages from x86_64 (osx-64) specific sub-directories.

This will enable users to create an environment that installs arm64 or x86_64 (osx-64) Python packages depending on the value defined by CONDA_SUBDIR.
</blockquote>

##### 4. Package management in an enviroment
{% highlight terminal %}
conda install xxx
{% endhighlight %}

For packages that are not available through conda, you'll need
{% highlight terminal %}
pip install xxx
{% endhighlight %}

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/img/posts/python-ldap.jpg" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

<div class="caption">
    Figure. Example output of package installation from subdirectory osx-64.
</div>

#### References
<ul>
    <li><a href="https://towardsdatascience.com/how-to-manage-conda-environments-on-an-apple-silicon-m1-mac-1e29cb3bad12">How to Manage Conda Environments on an Apple Silicon M1 Mac</a>.</li>
    <li><a href="https://towardsdatascience.com/python-conda-environments-for-both-arm64-and-x86-64-on-m1-apple-silicon-147b943ffa55">Python Conda Environments for Both arm64 and x86_64 on M1 Apple Silicon</a>.</li>
</ul>
