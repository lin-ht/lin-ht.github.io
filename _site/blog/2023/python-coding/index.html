<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Python coding | Haiting  Lin</title>
    <meta name="author" content="Haiting  Lin">
    <meta name="description" content="Cheatsheet">
    <meta name="keywords" content="haiting, Adobe">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2023/python-coding/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Haiting </span>Lin</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">Publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Python coding</h1>
    <p class="post-meta">May 12, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>
        ·  
        <a href="/blog/tag/notes">
          <i class="fas fa-hashtag fa-sm"></i> notes</a>  
          <a href="/blog/tag/code">
          <i class="fas fa-hashtag fa-sm"></i> code</a>  
          
        ·  
        <a href="/blog/category/note-posts">
          <i class="fas fa-tag fa-sm"></i> note-posts</a>  
          

    </p>
  </header>

  <article class="post-content">
<!--      -->
    <div id="markdown-content">
      <h4 id="python-decorator-usage">Python decorator usage</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 1: logging.
</span><span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="s">"logs.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s">"Called func with "</span> <span class="o">+</span> <span class="s">" "</span><span class="p">.</span><span class="nf">join</span><span class="p">([</span><span class="nf">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span> <span class="o">+</span> <span class="s">" at "</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="nf">now</span><span class="p">())</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="c1"># Same as writing run = log(run)
</span><span class="nd">@log</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>

<span class="nf">run</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 2: class singleton instance.
</span><span class="k">def</span> <span class="nf">singleton</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
	<span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">def</span> <span class="nf">getinstance</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">instances</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nf">cls</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">instances</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">getinstance</span>

<span class="nd">@singleton</span>
<span class="k">class</span> <span class="nc">MyClass</span><span class="p">:</span>
    <span class="p">...</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 3: add attributes to a function.
</span><span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="nf">setattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">return</span> <span class="n">decorate</span>

<span class="nd">@attrs</span><span class="p">(</span><span class="n">versionadded</span><span class="o">=</span><span class="s">"2.2"</span><span class="p">,</span>
       <span class="n">author</span><span class="o">=</span><span class="s">"Guido van Rossum"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mymethod</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>
<blockquote>
<p style="font-size:16px">
If the attribute is not found, setattr() creates a new attribute and assigns value to it. However, this is only possible if the object implements the __dict__() method.
</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 4: enforce function argument and return types.
</span><span class="k">def</span> <span class="nf">accepts</span><span class="p">(</span><span class="o">*</span><span class="n">types</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_accepts</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">==</span> <span class="n">f</span><span class="p">.</span><span class="n">func_code</span><span class="p">.</span><span class="n">co_argcount</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="nf">for </span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> \
                       <span class="s">"arg %r does not match %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="n">new_f</span><span class="p">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">func_name</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">return</span> <span class="n">check_accepts</span>

<span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">rtype</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_returns</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new_f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">rtype</span><span class="p">),</span> \
                   <span class="s">"return value %r does not match %s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">rtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="n">new_f</span><span class="p">.</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">func_name</span>
        <span class="k">return</span> <span class="n">new_f</span>
    <span class="k">return</span> <span class="n">check_returns</span>

<span class="nd">@accepts</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span>
<span class="nd">@returns</span><span class="p">((</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">arg1</span> <span class="o">*</span> <span class="n">arg2</span>
</code></pre></div></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 5: Declare that a class implements a particular (set of) interface(s).
</span><span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="o">*</span><span class="n">interfaces</span><span class="p">):</span>
     <span class="s">"""
     An actual, working, implementation of provides for
     the current implementation of PyProtocols.  Not
     particularly important for the PEP text.
     """</span>
     <span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
         <span class="nf">declareImplementation</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">instancesProvide</span><span class="o">=</span><span class="n">interfaces</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">typ</span>
     <span class="k">return</span> <span class="n">provides</span>

<span class="k">class</span> <span class="nc">IBar</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
     <span class="s">"""Declare something about IBar here"""</span>

<span class="nd">@provides</span><span class="p">(</span><span class="n">IBar</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="s">"""Implement something here..."""</span>
</code></pre></div></div>
<p>Commen decorators in python:</p>
<ul>
    <li>@property</li>
    <li>@classmethod</li>
    <li>@staticmethod</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Mass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kilos</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">kilos</span> <span class="o">=</span> <span class="n">kilos</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pounds</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">kilos</span> <span class="o">*</span> <span class="mf">2.205</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pounds</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pounds</span><span class="p">):</span>
        <span class="c1"># convert pounds to kilos
</span>        <span class="n">kilos</span> <span class="o">=</span> <span class="n">pounds</span> <span class="o">/</span> <span class="mf">2.205</span>
        <span class="c1"># cls is the same as Weight. calling cls(kilos) is the same as Weight(kilos)
</span>        <span class="k">return</span> <span class="nf">cls</span><span class="p">(</span><span class="n">kilos</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">conversion_info</span><span class="p">():</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Kilos are converted to pounds by multiplying by 2.205."</span><span class="p">)</span>

</code></pre></div></div>
<blockquote>
<p style="font-size:16px">
A static method is tied to the class, not to its instance. This may remind you of a class method but the key difference is that a static method doesn’t modify the class at all. In other words, a static method doesn’t take self or cls as its arguments. 
</p>
</blockquote>

<h4 id="type-annotation-and-protocol-usage">Type annotation and protocol usage</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 1: protocol
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="k">class</span> <span class="nc">HasBirthYear</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
	<span class="c1"># use ellipsis (...) as the function body.
</span>    <span class="k">def</span> <span class="nf">get_birthyear</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="p">...</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">birthyear</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">birthyear</span> <span class="o">=</span> <span class="n">birthyear</span>

    <span class="k">def</span> <span class="nf">get_birthyear</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">birthyear</span>

<span class="k">def</span> <span class="nf">calc_age</span><span class="p">(</span><span class="n">current_year</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HasBirthYear</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">current_year</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="nf">get_birthyear</span><span class="p">()</span>

<span class="n">john</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="s">"john doe"</span><span class="p">,</span> <span class="mi">1996</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 2: Add type hints for Iterable class.
# Iterable type that implements the __iter__ method.
</span><span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="k">def</span> <span class="nf">double_elements</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">double_elements</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]))</span> <span class="c1"># list
</span><span class="nf">print</span><span class="p">(</span><span class="nf">double_elements</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>     <span class="c1"># tuple
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 3: Add type hints for Sequence class.
# Sequence type that have special methods: __getitem__ and __len__.
</span><span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>

<span class="k">def</span> <span class="nf">get_last_element</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">first_item</span> <span class="o">=</span> <span class="nf">get_last_element</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>    <span class="c1"># 5
</span><span class="n">second_item</span> <span class="o">=</span> <span class="n">get_last_element</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>    <span class="c1"># 8
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 4: Add type hints for Mapping class.
# Mapping type that implements the following methods:
#   __getitem__: for accessing an element
#   __iter__: for iterating
#   __len__: computing the length
</span><span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="k">def</span> <span class="nf">get_full_name</span><span class="p">(</span><span class="n">student</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">student</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">)</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">student</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"last_name"</span><span class="p">)</span><span class="si">}</span><span class="s">'</span>

<span class="n">john</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">"first_name"</span><span class="p">:</span> <span class="s">"John"</span><span class="p">,</span>
  <span class="s">"last_name"</span><span class="p">:</span> <span class="s">"Doe"</span><span class="p">,</span>
<span class="p">}</span>

<span class="nf">get_full_name</span><span class="p">(</span><span class="n">john</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 5: Add type hints for MutableMapping class.
# Mapping type that implements the following methods:
#   __getitem__: for accessing an element
#   __setitem__: for setting an element
#   __delitem__: for deleting an element
#   __iter__: for iterating
#   __len__: computing the length
</span><span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>

<span class="k">def</span> <span class="nf">update_first_name</span><span class="p">(</span><span class="n">student</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">student</span><span class="p">[</span><span class="s">"first_name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_name</span>

<span class="n">john</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"first_name"</span><span class="p">:</span> <span class="s">"John"</span><span class="p">,</span>
    <span class="s">"last_name"</span><span class="p">:</span> <span class="s">"Doe"</span><span class="p">,</span>
<span class="p">}</span>

<span class="nf">update_first_name</span><span class="p">(</span><span class="n">john</span><span class="p">,</span> <span class="s">"james"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 6: Add type hints to tuples
# Annotate a tuple with two elements
</span><span class="n">student</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">"John Doe"</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="c1"># Annotate a tuple with an unknown amount of elements of a similar type
</span><span class="n">letters</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">...]</span> <span class="o">=</span> <span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="s">'h'</span><span class="p">,</span> <span class="s">'j'</span><span class="p">,</span> <span class="s">'n'</span><span class="p">,</span> <span class="s">'m'</span><span class="p">,</span> <span class="s">'n'</span><span class="p">,</span> <span class="s">'z'</span><span class="p">)</span>

<span class="c1"># Annotate a tuple with a named type
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>

<span class="k">class</span> <span class="nc">StudentTuple</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">john</span> <span class="o">=</span> <span class="nc">StudentTuple</span><span class="p">(</span><span class="s">"John Doe"</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 7: Add type hints to TypedDict.
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span> <span class="nc">StudentDict</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">hobbies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="n">student1</span><span class="p">:</span> <span class="n">StudentDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"first_name"</span><span class="p">:</span> <span class="s">"John"</span><span class="p">,</span>
    <span class="s">"last_name"</span><span class="p">:</span> <span class="s">"Doe"</span><span class="p">,</span>
    <span class="s">"age"</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
    <span class="s">"hobbies"</span><span class="p">:</span> <span class="p">[</span><span class="s">"singing"</span><span class="p">,</span> <span class="s">"dancing"</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 8: Add type hints for a union type.
</span><span class="k">def</span> <span class="nf">show_type</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nf">if</span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"You entered a string"</span><span class="p">)</span>
    <span class="nf">elif </span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"You entered an integer"</span><span class="p">)</span>

<span class="nf">show_type</span><span class="p">(</span><span class="s">'hello'</span><span class="p">)</span> <span class="c1"># You entered a string
</span><span class="nf">show_type</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>       <span class="c1"># You entered an integer
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 9: overloaded function
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">overload</span>

<span class="c1"># Decorator: @overload
</span><span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_number</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="p">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_number</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span> <span class="p">...</span>

<span class="k">def</span> <span class="nf">add_number</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="n">num</span>
    <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">num</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">add_number</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">add_number</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 10: Add type hints for optional parameters
</span><span class="k">def</span> <span class="nf">format_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Name: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">name</span><span class="p">.</span><span class="nf">title</span><span class="p">()</span><span class="si">}</span><span class="s">"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">"Name: </span><span class="si">{</span><span class="n">name</span><span class="p">.</span><span class="nf">title</span><span class="p">()</span><span class="si">}</span><span class="s">"</span>

<span class="nf">format_name</span><span class="p">(</span><span class="s">"john doe"</span><span class="p">,</span> <span class="s">"Mr"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="pytest">Pytest</h4>
<p>The <a href="https://docs.pytest.org/en/7.3.x/index.html" rel="external nofollow noopener" target="_blank">pytest framework</a> makes it easy to write small, readable tests, and can scale to support complex functional testing for applications and libraries. Pytest is equiped with metabuild ability so that it can compile the test files as desired.</p>

<p>What is <a href="https://docs.pytest.org/en/7.3.x/explanation/fixtures.html#about-fixtures" rel="external nofollow noopener" target="_blank">fixtures</a>? We can tell pytest that a particular function is a fixture by decorating it with <code class="language-plaintext highlighter-rouge">@pytest.fixture</code>. Fixtures are acquired by test funcitons by <a href="https://docs.pytest.org/en/7.3.x/how-to/fixtures.html#how-to-fixtures" rel="external nofollow noopener" target="_blank">declaring them as arguments</a>. Pytest has several useful <a href="https://docs.pytest.org/en/7.3.x/reference/fixtures.html" rel="external nofollow noopener" target="_blank">built-in fixtures</a>.</p>

<p><a href="https://docs.pytest.org/en/7.3.x/how-to/parametrize.html" rel="external nofollow noopener" target="_blank">How to parametrize fixtures and test functions</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run all the tests in a repo</span>
pytest

<span class="c"># run a specific test</span>
<span class="nb">cd</span> /path/to/code/
pytest <span class="nt">-v</span> test_file.py::test_case
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># content of test_expectation.py
</span><span class="kn">import</span> <span class="n">pytest</span>

<span class="c1"># pytest mark a function
</span><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s">"test_input,expected"</span><span class="p">,</span> <span class="p">[(</span><span class="s">"3+5"</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="s">"2+4"</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s">"6*9"</span><span class="p">,</span> <span class="mi">42</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nf">eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

<span class="c1"># pytest mark a class
</span><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s">"n,expected"</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_simple_case</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_weird_simple_case</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="nf">assert </span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pytest</span>
<span class="c1"># global pytest mark which parametrize all tests in a module
</span><span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="nf">parametrize</span><span class="p">(</span><span class="s">"n,expected"</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>

<span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_simple_case</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_weird_simple_case</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="nf">assert </span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># mark individual test instances
</span><span class="kn">import</span> <span class="n">pytest</span>

<span class="c1"># use built-in xfail to set an expected failure test.
</span><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span>
    <span class="s">"test_input,expected"</span><span class="p">,</span>
    <span class="p">[(</span><span class="s">"3+5"</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="s">"2+4"</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">pytest</span><span class="p">.</span><span class="nf">param</span><span class="p">(</span><span class="s">"6*9"</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="n">marks</span><span class="o">=</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">xfail</span><span class="p">)],</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nf">eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</code></pre></div></div>

<h4 id="module-import">Module import</h4>

<p>Module import using importlib and pkgutil.extend_path to 
handle separate source file folders under a same package/module name:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Examine the current imported modules and paths
</span><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">importlib</span>
<span class="n">sys</span><span class="p">.</span><span class="n">modules</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path_importer_cache</span>
</code></pre></div></div>

<p>1) Manual import workaround:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">importlib</span>

<span class="n">pkgname</span> <span class="o">=</span> <span class="s">'clio'</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">finder</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">path_importer_cache</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
  <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">finder</span><span class="p">,</span> <span class="n">importlib</span><span class="p">.</span><span class="n">machinery</span><span class="p">.</span><span class="n">FileFinder</span><span class="p">):</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">finder</span><span class="p">.</span><span class="nf">find_spec</span><span class="p">(</span><span class="n">pkgname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Adding spec </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s"> and exec module'</span><span class="p">)</span>
      <span class="n">modl</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

      <span class="n">loader</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">LazyLoader</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">loader</span><span class="p">)</span>
      <span class="n">spec</span><span class="p">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
      <span class="n">spec</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="nf">exec_module</span><span class="p">(</span><span class="n">modl</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">pkgname</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">pkgname</span><span class="p">]</span> <span class="o">=</span> <span class="n">modl</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">pkgname</span><span class="p">].</span><span class="n">__path__</span> <span class="o">+=</span> <span class="n">spec</span><span class="p">.</span><span class="n">submodule_search_locations</span>


<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'sys.modules[</span><span class="si">{</span><span class="n">pkgname</span><span class="si">}</span><span class="s">] = </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">pkgname</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'sys.modules[</span><span class="si">{</span><span class="n">pkgname</span><span class="si">}</span><span class="s">].__path__ = </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">pkgname</span><span class="p">].</span><span class="n">__path__</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="n">subpkgname</span> <span class="o">=</span> <span class="s">'core_models'</span>
<span class="n">subpkgfullname</span> <span class="o">=</span> <span class="n">pkgname</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">subpkgname</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Pre-Import is key </span><span class="si">{</span><span class="n">subpkgfullname</span><span class="si">}</span><span class="s"> in sys.modules: </span><span class="si">{</span><span class="n">subpkgfullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">pkgname</span><span class="p">].</span><span class="n">__path__</span><span class="p">:</span>
  <span class="n">finder</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">machinery</span><span class="p">.</span><span class="nc">FileFinder</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
  <span class="n">spec</span> <span class="o">=</span> <span class="n">finder</span><span class="p">.</span><span class="nf">find_spec</span><span class="p">(</span><span class="n">subpkgfullname</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Adding spec </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s"> and exec module'</span><span class="p">)</span>
      <span class="n">modl</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nf">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

      <span class="k">assert</span> <span class="n">spec</span><span class="p">.</span><span class="n">loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">"loader can't be None"</span>
      <span class="n">loader</span> <span class="o">=</span> <span class="n">importlib</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="nc">LazyLoader</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">loader</span><span class="p">)</span>
      <span class="n">spec</span><span class="p">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loader</span>
      <span class="n">spec</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="nf">exec_module</span><span class="p">(</span><span class="n">modl</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">subpkgfullname</span> <span class="ow">in</span> <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">subpkgfullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">modl</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">subpkgfullname</span><span class="p">].</span><span class="n">__path__</span> <span class="o">+=</span> <span class="n">spec</span><span class="p">.</span><span class="n">submodule_search_locations</span>

<span class="c1"># importlib.import_module doesn't deal with multiple locations
# submodl = importlib.import_module(subpkgfullname)
</span>
<span class="c1"># print(submodl)
# print(f"dir(submodl of {submodl.__name__})={dir(submodl)}")
</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'PostImport sys.modules[</span><span class="si">{</span><span class="n">subpkgfullname</span><span class="si">}</span><span class="s">].__path__ = </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">modules</span><span class="p">[</span><span class="n">subpkgfullname</span><span class="p">].</span><span class="n">__path__</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

<span class="c1"># now import what we need
# import clio.ait_models.unets
# import clio.core_models.unets
</span><span class="kn">import</span> <span class="n">clio.export.aitemplate_export</span>
</code></pre></div></div>

<p>2) Recommended solution:
In order to let python be aware of the situation (identical package name with different file paths), use <code class="language-plaintext highlighter-rouge">pkguitl.extend_path</code> in the first imported module <strong>init</strong>.py to configure the python import behavior.</p>

<p>Put the following code in the <strong>init</strong>.py of the package folder that will be the first to load under the same parent package name:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pkgutil</span> <span class="kn">import</span> <span class="n">extend_path</span>
<span class="c1"># Extend path to include all module paths with an identical parent package name
</span><span class="n">__path__</span> <span class="o">=</span> <span class="nf">extend_path</span><span class="p">(</span><span class="n">__path__</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>
</code></pre></div></div>
<p>For example, we put the above code in the following files:</p>
<ol>
  <li>cliocore/ait_models/unets/src/clio/<strong>init</strong>.py</li>
  <li>cliocore/core_models/autoencoders/src/clio/core_models/<strong>init</strong>.py</li>
</ol>

<p>Then the <strong>path</strong> for the loaded module will be the list of all the modules under the same name.</p>

<h4 id="asyncrunner">AsyncRunner</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">from</span> <span class="n">collections.abc</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="n">gevent</span>

<span class="k">class</span> <span class="nc">AsyncRunner</span><span class="p">:</span>
    <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">AbstractEventLoop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">new_event_loop</span><span class="p">()</span>
    <span class="n">lock</span><span class="p">:</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
    <span class="c1"># Dedicated thread to handle even loop.
</span>    <span class="n">thread</span><span class="p">:</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span> <span class="o">|</span> <span class="bp">None</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">start_event_loop</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cls</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cls</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">cls</span><span class="p">.</span><span class="n">loop</span><span class="p">.</span><span class="n">run_forever</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cls</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">stop_event_loop</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cls</span><span class="p">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cls</span><span class="p">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cls</span><span class="p">.</span><span class="n">loop</span><span class="p">.</span><span class="nf">call_soon_threadsafe</span><span class="p">(</span><span class="n">cls</span><span class="p">.</span><span class="n">loop</span><span class="p">.</span><span class="n">stop</span><span class="p">)</span>
                <span class="n">cls</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
                <span class="n">cls</span><span class="p">.</span><span class="n">thread</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">coro</span><span class="p">:</span> <span class="n">Coroutine</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">cls</span><span class="p">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        
        <span class="n">fu</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">cls</span><span class="p">.</span><span class="n">loop</span><span class="p">)</span>

        <span class="n">ev</span> <span class="o">=</span> <span class="n">gevent</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
        <span class="n">fu</span><span class="p">.</span><span class="nf">add_done_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">ev</span><span class="p">.</span><span class="nf">set</span><span class="p">())</span>
        <span class="n">ev</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fu</span><span class="p">.</span><span class="nf">result</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="misc">MISC</h4>

<p>Ruff extension for VSCode as a quick linter:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruff check <span class="nt">--exclude</span> clio-docker <span class="nt">--ignore</span> ANN,D <span class="nb">.</span> 
ruff check <span class="nt">--exclude</span> clio-docker <span class="nt">--select</span> UP <span class="nb">.</span> <span class="o">[</span><span class="nt">--fix</span><span class="o">]</span>

ruff rule S101
</code></pre></div></div>

<p>mypy for annotation check. (Check rules installed in <code class="language-plaintext highlighter-rouge">pyproject.toml</code>)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mypy /path/to/dir
</code></pre></div></div>

<p>Print Env var <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> in python:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="nf">print</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'LD_LIBRARY_PATH'</span><span class="p">])</span>
</code></pre></div></div>

<h4 id="references">References</h4>
<ul>
	<li><a href="https://peps.python.org/pep-0318/" rel="external nofollow noopener" target="_blank">PEP 318 – Decorators for Functions and Methods</a></li>
    <li>Decorators in python: <a href="https://builtin.com/software-engineering-perspectives/python-symbol" rel="external nofollow noopener" target="_blank">What Is the @ Symbol in Python and How Do I Use It?</a>
</li>
    <li>Packing&amp;unpacking using asterisk(*):<a href="https://www.scaler.com/topics/asterisk-python/" rel="external nofollow noopener" target="_blank"> What is the Asterisk Operator in Python?</a>
</li>
    <li>Type annotation and protocol: <a href="https://blog.logrocket.com/understanding-type-annotation-python/" rel="external nofollow noopener" target="_blank">Understanding type annotation in Python</a>
</li>
    <li>Pytest <a href="https://docs.pytest.org/en/7.3.x/reference/reference.html" rel="external nofollow noopener" target="_blank">API reference</a>
</li>
</ul>

    </div>
  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/displaying-external-posts-on-your-al-folio-blog/">Displaying External Posts on Your al-folio Blog</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/terminal-debug/">Terminal debugging</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/pytorch-coding/">Pytorch coding</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cuda-coding/">Cuda coding</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cvcuda-installation/">CVCuda installation</a>
  </li>

</div>

      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2024 Haiting  Lin. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>

  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js"></script>
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
